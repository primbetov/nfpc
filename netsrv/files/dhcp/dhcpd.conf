#
# DHCP Server Configuration file.
#   see /usr/share/doc/dhcp*/dhcpd.conf.sample
#   see 'man 5 dhcpd.conf'
#
#auto generated by alterator-dhcp-reset

use-host-decl-names on;
allow client-updates;
ddns-update-style none;
ddns-updates on;
ddns-domainname "nfpc.lan";


#include "/var/lib/bind/etc/ddns-key.conf"
key ddns-key {
    algorithm hmac-md5;
    secret "EZIkvXxJ6r0moVh9fC6Du14FXI3pqRuGG7AvvlML5HiEfMtQeFdYYqJN9Ob/v5u+2nmJOBUNv3NLw7bIOB+s/g==";
};

zone nfpc.lan {
        primary 127.0.0.1;
        key ddns-key;
}

authoritative;
log-facility local7;

# Настройка отказоустойчивости
#failover peer "dhcp-failover" {
#    primary;                    # Этот сервер главный
#    address 10.90.15.4;         # Его адрес
#    port 519;                   # Его порт
#    peer address 10.90.15.5;    # Адрес второго DHCP
#    peer port 520;              # Порт второго DHCP
#    # Дополнительные параметры настройки
#    max-response-delay 30;      # Время за которое сервер должен ответить, после он считается упавшим
#    max-unacked-updates 10;
#    load balance max seconds 3;
#    mclt 1800;                  # Время после синхронизации базы, через которое мастеру будут возвращены права
#    split 128;
#    # эта опция позволяет оставшемуся в работе DHCP серверу
#    # использовать ту половину пула адресов,
#    # которая осталась от "упавшего" сервера через Х секунд.
#    auto-partner-down 86400;    #за эту опцию спасибо @baf28
#}


###################################################################################
# Сбор информации с DHCP-relay
###################################################################################

set clientIP = binary-to-ascii(10, 8, ".", leased-address);
set clientMAC = binary-to-ascii(16, 8, ":", substring(hardware, 1, 6));
set clientName = pick-first-value(option host-name);


on commit {
    clientName = pick-first-value(option host-name, host-decl-name, "none");
    execute("/etc/dhcp/scripts/dnsupdate.sh", "ADD", clientIP, clientName, clientMAC);
}

on release {
    execute("/etc/dhcp/scripts/dnsupdate.sh", "DEL", ClientIP, ClientName);
}

on expiry {
    execute("/etc/dhcp/scripts/dnsupdate.sh", "DEL", ClientIP, ClientName);
}

###################################################################################
# Создаем описание для опций статических маршрутов
#
###################################################################################
# MS routes: adds extras to supplement routers option
option ms-classless-static-routes code 249 = array of unsigned integer 8;
# RFC3442 routes: overrides routers option
option rfc3442-classless-static-routes code 121 = array of unsigned integer 8;

include "/etc/dhcp/dhcpd.d/classes.conf";
#include "/etc/dhcp/dhcpd.d/pxe-classes.conf";
include "/etc/dhcp/dhcpd.d/hosts.conf";
#include "/etc/dhcp/dhcpd.d/vlan101.conf";
include "/etc/dhcp/dhcpd.d/vlan120.conf";
include "/etc/dhcp/dhcpd.d/vlan300.conf";
include "/etc/dhcp/dhcpd.d/vlan302.conf";
include "/etc/dhcp/dhcpd.d/vlan305.conf";
include "/etc/dhcp/dhcpd.d/vlan90.conf";